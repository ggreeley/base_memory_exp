/**
 * jspsych-survey-html-form
 * a jspsych plugin for free html forms
 *
 * Jan Simson
 *
 * documentation: docs.jspsych.org
 *
 */

jsPsych.plugins['survey-html-form-timed'] = (function() {

  var plugin = {};

  plugin.info = {
    name: 'survey-html-form-timed',
    description: '',
    parameters: {
      html: {
        type: jsPsych.plugins.parameterType.HTML_STRING,
        pretty_name: 'HTML',
        default: null,
        description: 'HTML formatted string containing all the input elements to display. Every element has to have its own distinctive name attribute. The <form> tag must not be included and is generated by the plugin.'
      },
      preamble: {
        type: jsPsych.plugins.parameterType.STRING,
        pretty_name: 'Preamble',
        default: null,
        description: 'HTML formatted string to display at the top of the page above all the questions.'
      },
      button_label: {
        type: jsPsych.plugins.parameterType.STRING,
        pretty_name: 'Button label',
        default:  'Continue',
        description: 'The text that appears on the button to finish the trial.'
      },
      autofocus: {
        type: jsPsych.plugins.parameterType.STRING,
        pretty_name: 'Element ID to focus',
        default: '',
        description: 'The HTML element ID of a form field to autofocus on.'
      },
      dataAsArray: {
        type: jsPsych.plugins.parameterType.BOOLEAN,
        pretty_name: 'Data As Array',
        default:  false,
        description: 'Retrieve the data as an array e.g. [{name: "INPUT_NAME", value: "INPUT_VALUE"}, ...] instead of an object e.g. {INPUT_NAME: INPUT_VALUE, ...}.'
      },
      autocomplete: {
        type: jsPsych.plugins.parameterType.BOOL,
        pretty_name: 'Allow autocomplete',
        default: false,
        description: "Setting this to true will enable browser auto-complete or auto-fill for the form."
      },
      trial_duration: {
        type: jsPsych.plugins.parameterType.INT,
        pretty_name: 'Trial duration',
        default: 1000,
        description: 'How long to show trial before it ends.'
      }
    }
  };

  plugin.trial = function(display_element, trial) {

    var html = '';
    // show preamble text
    if(trial.preamble !== null){
      html += '<div id="jspsych-survey-html-form-preamble" class="jspsych-survey-html-form-preamble">'+trial.preamble+'</div>';
    }
    // start form
    if ( trial.autocomplete ) {
      html += '<form id="jspsych-survey-html-form">'
    } else {
      html += '<form id="jspsych-survey-html-form" autocomplete="off">'
    }

    // add form HTML / input elements
    html += trial.html;

    // add submit button
    //html += '<input type="submit" id="jspsych-survey-html-form-next" class="jspsych-btn jspsych-survey-html-form" value="'+trial.button_label+'"></input>';

    html += '</form>';
    display_element.innerHTML = html;

    if ( trial.autofocus !== '' ) {
      var focus_elements = display_element.querySelectorAll('#'+trial.autofocus);
      if ( focus_elements.length === 0 ) {
	      console.warn('No element found with id: '+trial.autofocus);
      } else if ( focus_elements.length > 1 ) {
	      console.warn('The id "'+trial.autofocus+'" is not unique so autofocus will not work.');
      } else {
	      focus_elements[0].focus();
      }
    }

    function end_trial() {
        // kill any remaining setTimeout handlers
      jsPsych.pluginAPI.clearAllTimeouts();
        // kill keyboard listeners
      jsPsych.pluginAPI.cancelAllKeyboardResponses();

      //var endTime = performance.now();
      //var response_time = endTime - startTime;

      var question_data = serializeArray(this);

      if (!trial.dataAsArray) {
        question_data = objectifyForm(question_data);
      };

        // gather the data to store for the trial
      var trialdata = {
          //"rt": response_time,
          "responses": JSON.stringify(question_data)
        };
  
        // clear the display
      display_element.innerHTML = '';
  
        // move on to the next trial
      jsPsych.finishTrial(trialdata);
      };

    // end trial if trial_duration is set
    if (trial.trial_duration !== null) {
      jsPsych.pluginAPI.setTimeout(function() {
        end_trial();
      }, trial.trial_duration);
    }
  };

  return plugin;

})();